<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fast shap values computations for ensamble models • treeshap</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- dalexverse --><link href="dalexverse.css" rel="stylesheet">
<link href="dalexverse-2.css" rel="stylesheet">
<!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Fast shap values computations for ensamble models">
<meta property="og:description" content="Eefficient tool capable of explaining the prediction made by an ensemble model in short, polynomial time.">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- google analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-5650686-14"></script><script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-5650686-14');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="index.html">treeshap</a>
        <div class="info">
          <span class="partof">part of the <a href="https://github.com/ModelOriented/DrWhy">DrWhy.AI</a>
           developed by the <a href="https://mi2.mini.pw.edu.pl/">MI^2 DataLab</a> </span>
          <span class="version version-default">0.0.0.9000</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
        <li>
  <a href="https://github.com/ModelOriented/treeshap/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="treeshap" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#treeshap" class="anchor"></a>treeshap</h1></div>
<!-- badges: start -->
<!-- badges: end -->
<p>In the era of complicated classifiers conquering their market, sometimes even the authors of algorithms do not know the exact manner of building a tree ensemble model. The difficulties in models’ structures are one of the reasons why most users use them simply like black-boxes. But, how can they know whether the prediction made by the model is reasonable? <code>treeshap</code> is an efficient answer for this question. Due to implementing an optimised alghoritm for tree ensemble models, it calculates the SHAP values in polynomial (instead of exponential) time. This metric is the only possible way to measure the influence of every feature regardless of the permutation of features. Moreover, <code>treeshap</code> package shares a bunch of functions to unify the structure of a model. Currently it supports models produced with <code>XGBoost</code>, <code>LightGBM</code>, <code>GBM</code>, <code>Catboost</code>, <code>ranger</code> and <code>randomForest</code>.</p>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>You can install the released version of treeshap using package <code>devtools</code> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">'ModelOriented/treeshap'</span><span class="op">)</span></pre></div>
</div>
<div id="example" class="section level2">
<h2 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h2>
<p>First of all, let’s focus on an example how to represent a <code>xgboost</code> model as a unified data frame:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ModelOriented/treeshap">treeshap</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost">xgboost</a></span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="va">fifa20</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">fifa20</span><span class="op">$</span><span class="va">data</span><span class="op">)</span> <span class="op">!=</span> <span class="st">'work_rate'</span><span class="op">]</span>
<span class="va">target</span> <span class="op">&lt;-</span> <span class="va">fifa20</span><span class="op">$</span><span class="va">target</span>
<span class="va">param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>objective <span class="op">=</span> <span class="st">"reg:squarederror"</span>, max_depth <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>
<span class="va">xgb_model</span> <span class="op">&lt;-</span> <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, params <span class="op">=</span> <span class="va">param</span>, label <span class="op">=</span> <span class="va">target</span>, nrounds <span class="op">=</span> <span class="fl">200</span>, verbose <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="va">unified</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/xgboost.unify.html">xgboost.unify</a></span><span class="op">(</span><span class="va">xgb_model</span><span class="op">)</span>
<span class="va">unified</span>
<span class="co">#&gt;        Tree Node   Feature Split Yes No Missing Quality/Score Cover</span>
<span class="co">#&gt;     1:    0    0   overall  81.5   2  3       2  3.060549e+17 18278</span>
<span class="co">#&gt;     2:    0    1   overall  73.5   4  5       4  1.130790e+17 17949</span>
<span class="co">#&gt;     3:    0    2   overall  84.5   6  7       6  4.021330e+16   329</span>
<span class="co">#&gt;     4:    0    3   overall  69.5   8  9       8  1.165151e+16 15628</span>
<span class="co">#&gt;     5:    0    4 potential  79.5  10 11      10  1.813107e+16  2321</span>
<span class="co">#&gt;    ---                                                             </span>
<span class="co">#&gt; 17850:  199   50      &lt;NA&gt;    NA  NA NA      NA -2.284977e+03     8</span>
<span class="co">#&gt; 17851:  199   51      &lt;NA&gt;    NA  NA NA      NA -1.966713e+03   167</span>
<span class="co">#&gt; 17852:  199   52      &lt;NA&gt;    NA  NA NA      NA -2.034138e+04    12</span>
<span class="co">#&gt; 17853:  199   53      &lt;NA&gt;    NA  NA NA      NA  1.711017e+04    15</span>
<span class="co">#&gt; 17854:  199   54      &lt;NA&gt;    NA  NA NA      NA  4.351900e+02    44</span></pre></div>
<p>Having the data frame of unified structure, it is a piece of cake to produce shap values of a prediction for a specific observation. The <code><a href="reference/treeshap.html">treeshap()</a></code> function requires passing two data frames: one representing an ensemble model and one with the observations about which we want to get the explanation. Obviously, the latter one should contain the same columns as data used during building the model.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="va">treeshap_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/treeshap.html">treeshap</a></span><span class="op">(</span><span class="va">unified</span>,  <span class="va">data</span><span class="op">[</span><span class="fl">700</span><span class="op">:</span><span class="fl">800</span>, <span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">treeshap_values</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;          age height_cm weight_kg overall potential international_reputation</span>
<span class="co">#&gt; 1   297154.4  5769.186 12136.316 8739757  212428.8               -50855.738</span>
<span class="co">#&gt; 2 -2550066.6 16011.136  3134.526 6525123  244814.2                22784.430</span>
<span class="co">#&gt; 3   300830.3 -9023.299 15374.550 8585145  479118.8                 2374.351</span>
<span class="co">#&gt; 4  -132645.2 12380.183 33731.893 8321266  357679.5                49019.904</span>
<span class="co">#&gt; 5   689402.9 -3369.050 16433.595 8933670  427577.5                12147.246</span>
<span class="co">#&gt; 6 -1042288.0  5760.739  8428.627 6579288  289577.8                66873.547</span></pre></div>
<p>We can also compute SHAP values for interactions. As an example we will calculate them for a model built with simpler (only 5 columns) data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">data2</span> <span class="op">&lt;-</span> <span class="va">fifa20</span><span class="op">$</span><span class="va">data</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>
<span class="va">xgb_model2</span> <span class="op">&lt;-</span> <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">data2</span><span class="op">)</span>, params <span class="op">=</span> <span class="va">param</span>, label <span class="op">=</span> <span class="va">target</span>, nrounds <span class="op">=</span> <span class="fl">200</span>, verbose <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="va">unified2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/xgboost.unify.html">xgboost.unify</a></span><span class="op">(</span><span class="va">xgb_model2</span><span class="op">)</span>
<span class="va">treeshap_interactions</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/treeshap.html">treeshap</a></span><span class="op">(</span><span class="va">unified2</span>,  <span class="va">data2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="op">]</span>, interactions <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">treeshap_interactions</span>
<span class="co">#&gt; , , 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                   age  height_cm  weight_kg     overall  potential</span>
<span class="co">#&gt; age       -1886241.70   -3984.09  -96765.97   -47245.92  1034657.6</span>
<span class="co">#&gt; height_cm    -3984.09 -628797.41  -35476.11  1871689.75   685472.2</span>
<span class="co">#&gt; weight_kg   -96765.97  -35476.11 -983162.25  2546930.16  1559453.5</span>
<span class="co">#&gt; overall     -47245.92 1871689.75 2546930.16 55289985.16 12683135.3</span>
<span class="co">#&gt; potential  1034657.61  685472.23 1559453.46 12683135.27   868268.7</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; , , 2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                  age  height_cm  weight_kg    overall  potential</span>
<span class="co">#&gt; age       -2349987.9  306165.41  120483.91 -9871270.0  960198.02</span>
<span class="co">#&gt; height_cm   306165.4  -78810.31  -48271.61  -991020.7  -44632.74</span>
<span class="co">#&gt; weight_kg   120483.9  -48271.61  -21657.14  -615688.2 -380810.70</span>
<span class="co">#&gt; overall   -9871270.0 -991020.68 -615688.21 57384425.2 9603937.05</span>
<span class="co">#&gt; potential   960198.0  -44632.74 -380810.70  9603937.1 2994190.74</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; attr(,"class")</span>
<span class="co">#&gt; [1] "array"             "shap.interactions"</span></pre></div>
</div>
<div id="plotting-results" class="section level2">
<h2 class="hasAnchor">
<a href="#plotting-results" class="anchor"></a>Plotting results</h2>
<p>The package currently provides 3 plotting functions that can be used</p>
<div id="feature-contribution-break-down" class="section level3">
<h3 class="hasAnchor">
<a href="#feature-contribution-break-down" class="anchor"></a>Feature Contribution (Break-Down)</h3>
<p>On this plot we can see how features contribute into the prediction for a single observation. It is similar to the Break Down plot from <a href="https://github.com/ModelOriented/iBreakDown">iBreakDown</a> package, which uses different method to approximate SHAP values.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="reference/plot_contribution.html">plot_contribution</a></span><span class="op">(</span><span class="va">treeshap_values</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, <span class="va">data</span><span class="op">[</span><span class="fl">700</span>, <span class="op">]</span>, <span class="va">unified</span>, min_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">12000000</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="reference/figures/README-plot_contribution_example-1.png" width="100%"></p>
</div>
<div id="feature-importance" class="section level3">
<h3 class="hasAnchor">
<a href="#feature-importance" class="anchor"></a>Feature Importance</h3>
<p>This plot shows us average absolute impact of features on the prediction of the model.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="reference/plot_feature_importance.html">plot_feature_importance</a></span><span class="op">(</span><span class="va">treeshap_values</span>, max_vars <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></pre></div>
<p><img src="reference/figures/README-plot_importance_example-1.png" width="100%"></p>
</div>
<div id="feature-dependence" class="section level3">
<h3 class="hasAnchor">
<a href="#feature-dependence" class="anchor"></a>Feature Dependence</h3>
<p>Using this plot we can see, how a single feature contributes into the prediction depending on its value.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="fu"><a href="reference/plot_feature_dependence.html">plot_feature_dependence</a></span><span class="op">(</span><span class="va">treeshap_values</span>, <span class="va">data</span><span class="op">[</span><span class="fl">700</span><span class="op">:</span><span class="fl">800</span>, <span class="op">]</span>, <span class="st">"height_cm"</span><span class="op">)</span></pre></div>
<p><img src="reference/figures/README-plot_dependence_example-1.png" width="100%"></p>
</div>
</div>
<div id="how-fast-does-it-work" class="section level2">
<h2 class="hasAnchor">
<a href="#how-fast-does-it-work" class="anchor"></a>How fast does it work?</h2>
<p>Complexity of TreeSHAP is <code>O(TLD^2)</code>, where <code>T</code> is number of trees, <code>L</code> is number of leaves in a tree and <code>D</code> is depth of a tree.</p>
<p>Our implementation works in speed comparable to original Lundberg’s Python package <code>shap</code> implementation using C and Python.</p>
<p>In the following example our TreeSHAP implementation explains 300 observations on a model consisting of 200 trees of max depth = 6 in les than 2 seconds.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu">microbenchmark</span><span class="op">(</span>
  treeshap <span class="op">=</span> <span class="fu"><a href="reference/treeshap.html">treeshap</a></span><span class="op">(</span><span class="va">unified</span>,  <span class="va">data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">300</span>, <span class="op">]</span><span class="op">)</span>, <span class="co"># using model and dataset from the example</span>
  times <span class="op">=</span> <span class="fl">5</span>
<span class="op">)</span>
<span class="co">#&gt; Unit: seconds</span>
<span class="co">#&gt;      expr      min       lq    mean   median       uq      max neval</span>
<span class="co">#&gt;  treeshap 1.782249 1.784161 1.80818 1.792438 1.812077 1.869973     5</span></pre></div>
<p>Complexity of SHAP interaction values computation is <code>O(MTLD^2)</code>, where <code>M</code> is number of variables in explained dataset, <code>T</code> is number of trees, <code>L</code> is number of leaves in a tree and <code>D</code> is depth of a tree.</p>
<p>SHAP Interaction values for 5 variables, model consisting of 200 trees of max depth = 6 and 300 observations can be computed in less than 8 seconds.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu">microbenchmark</span><span class="op">(</span>
  treeshap <span class="op">=</span> <span class="fu"><a href="reference/treeshap.html">treeshap</a></span><span class="op">(</span><span class="va">unified2</span>, <span class="va">data2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">300</span>, <span class="op">]</span>, interactions <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="co"># using model and dataset from the example</span>
  times <span class="op">=</span> <span class="fl">5</span>
<span class="op">)</span>
<span class="co">#&gt; Unit: seconds</span>
<span class="co">#&gt;      expr      min       lq     mean   median      uq      max neval</span>
<span class="co">#&gt;  treeshap 7.088556 7.135377 7.139961 7.136265 7.14475 7.194855     5</span></pre></div>
</div>
<div id="how-to-use-the-unifying-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#how-to-use-the-unifying-functions" class="anchor"></a>How to use the unifying functions?</h2>
<p>Even though the data frames produced by the functions from <code>.unify()</code> family (<code><a href="reference/xgboost.unify.html">xgboost.unify()</a></code>, <code><a href="reference/lightgbm.unify.html">lightgbm.unify()</a></code>, <code><a href="reference/gbm.unify.html">gbm.unify()</a></code>, <code><a href="reference/catboost.unify.html">catboost.unify()</a></code>, <code><a href="reference/randomForest.unify.html">randomForest.unify()</a></code>, <code><a href="reference/ranger.unify.html">ranger.unify()</a></code>) are identical when it comes to the structure, due to different possibilities of saving and representing the trees among the packages, the usage of functions is slightly different. As an argument, first three listed functions take an object of appropriate model. The latter one, <code><a href="reference/catboost.unify.html">catboost.unify()</a></code> requires a transformed dataset used for training the model - an object of class <code>catboost.Pool</code>. Both <code><a href="reference/randomForest.unify.html">randomForest.unify()</a></code> and <code><a href="reference/ranger.unify.html">ranger.unify()</a></code> also require a dataset to calculate Cover values, usually dataset used for training the model. Here is a short example representing usage of two functions:</p>
<div id="1-gbm" class="section level4">
<h4 class="hasAnchor">
<a href="#1-gbm" class="anchor"></a>1. GBM</h4>
<p>An argument of <code><a href="reference/gbm.unify.html">gbm.unify()</a></code> should be of <code>gbm</code> class - a gradient boosting model.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/gbm-developers/gbm">gbm</a></span><span class="op">)</span>
<span class="co">#&gt; Loaded gbm 2.1.5</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ModelOriented/treeshap">treeshap</a></span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="va">fifa20</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">fifa20</span><span class="op">$</span><span class="va">data</span><span class="op">)</span> <span class="op">!=</span> <span class="st">'work_rate'</span><span class="op">]</span>
<span class="va">x</span><span class="op">[</span><span class="st">'value_eur'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">fifa20</span><span class="op">$</span><span class="va">target</span>
<span class="va">gbm_model</span> <span class="op">&lt;-</span> <span class="fu">gbm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gbm/man/gbm.html">gbm</a></span><span class="op">(</span>
  formula <span class="op">=</span> <span class="va">value_eur</span> <span class="op">~</span> <span class="va">.</span>,
  data <span class="op">=</span> <span class="va">x</span>,
  distribution <span class="op">=</span> <span class="st">"laplace"</span>,
  n.trees <span class="op">=</span> <span class="fl">200</span>,
  cv.folds <span class="op">=</span> <span class="fl">2</span>,
  interaction.depth <span class="op">=</span> <span class="fl">2</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="reference/gbm.unify.html">gbm.unify</a></span><span class="op">(</span><span class="va">gbm_model</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;    Tree Node   Feature Split Yes No Missing Quality/Score Cover</span>
<span class="co">#&gt; 1:    0    0   overall  65.5   2  3       7       5484.52  9139</span>
<span class="co">#&gt; 2:    0    1      &lt;NA&gt;    NA  NA NA      NA     -37500.00  4230</span>
<span class="co">#&gt; 3:    0    2 potential  68.5   4  5       6       1017.26  4909</span>
<span class="co">#&gt; 4:    0    3      &lt;NA&gt;    NA  NA NA      NA      -7500.00   747</span>
<span class="co">#&gt; 5:    0    4      &lt;NA&gt;    NA  NA NA      NA     170000.00  4162</span>
<span class="co">#&gt; 6:    0    5      &lt;NA&gt;    NA  NA NA      NA     142989.92  4909</span></pre></div>
</div>
<div id="2-catboost" class="section level4">
<h4 class="hasAnchor">
<a href="#2-catboost" class="anchor"></a>2. Catboost</h4>
<p>For representing correct names of features that are regarding during splitting observations into sets, <code><a href="reference/catboost.unify.html">catboost.unify()</a></code> requires passing two arguments. Some values (Quality/Score) are unavailable for internal nodes in the data frame created on catboost model:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ModelOriented/treeshap">treeshap</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://catboost.ai/">catboost</a></span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="va">fifa20</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">fifa20</span><span class="op">$</span><span class="va">data</span><span class="op">)</span> <span class="op">!=</span> <span class="st">'work_rate'</span><span class="op">]</span>
<span class="va">label</span> <span class="op">&lt;-</span> <span class="va">fifa20</span><span class="op">$</span><span class="va">target</span>
<span class="va">dt.pool</span> <span class="op">&lt;-</span> <span class="fu">catboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/catboost/man/catboost.load_pool.html">catboost.load_pool</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">as.numeric</span><span class="op">)</span><span class="op">)</span>, label <span class="op">=</span> <span class="va">label</span><span class="op">)</span>
<span class="va">cat_model</span> <span class="op">&lt;-</span> <span class="fu">catboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/catboost/man/catboost.train.html">catboost.train</a></span><span class="op">(</span>
            <span class="va">dt.pool</span>,
            params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>loss_function <span class="op">=</span> <span class="st">'RMSE'</span>, iterations <span class="op">=</span> <span class="fl">100</span>, metric_period <span class="op">=</span> <span class="fl">10</span>,
                          logging_level <span class="op">=</span> <span class="st">'Silent'</span>, allow_writing_files <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="reference/catboost.unify.html">catboost.unify</a></span><span class="op">(</span><span class="va">cat_model</span>, <span class="va">dt.pool</span><span class="op">)</span><span class="op">)</span></pre></div>
</div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<ul>
<li>Scott M. Lundberg, Gabriel G. Erion, Su-In Lee, “Consistent Individualized Feature Attribution for Tree Ensembles”, University of Washington</li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/ModelOriented/treeshap/">https://​github.com/​ModelOriented/​treeshap/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/ModelOriented/treeshap/issues">https://​github.com/​ModelOriented/​treeshap/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a></small></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Konrad Komisarczyk <br><small class="roles"> Author, maintainer </small>  </li>
<li>Pawel Kozminski <br><small class="roles"> Author </small>  </li>
<li>Przemyslaw Biecek <br><small class="roles"> Author, copyright holder </small>  </li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p>Developed by Konrad Komisarczyk, Pawel Kozminski, Przemyslaw Biecek.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
